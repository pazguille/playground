<!doctype html>
<!--[if IE]><![endif]-->
<!--[if lt IE 7 ]> <html lang="es" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="es" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="es" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="es" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="es" class="no-js"> <!--<![endif]-->
	<head>
		<script></script>
		<meta charset="utf-8">
		<title>Meli Search</title>
		<link rel="stylesheet" href="http://chico-ui.com.ar/versions/0.7.7/chico-min-0.7.7.css">
		<link rel="stylesheet" href="src/css/mobile.css">
	</head>
	<body>	
	
		<header class="mainHeader">
			<a href="/" class="menuProvi">MercadoLibre</a> 
			<form id="formBusqueda" action="http://www.mercadolibre.com.ar/jm/search" method="GET">
				<input type="text" class="search" maxlength="60" tabindex="1" autocomplete="off">
			 	<input type="submit" value="Buscar" class="btn secondary" tabindex="2">
			 	<select name="site" id="site">
			 		<option value="MLA">Argentina</option>
			 		<option value="MLB">Brasil</option>
			 		<option value="MCO">Colombia</option>
			 		<option value="MCR">Costa Rica</option>
			 		<option value="MLC">Chile</option>
			 		<option value="MRD">Dominicana</option>
			 		<option value="MEC">Ecuador</option>
			 		<option value="MLM">Mexico</option>
			 		<option value="MPA">Panamá</option>
			 		<option value="MPE">Perú</option>
			 		<option value="MPT">Portugal</option>
			 		<option value="MLU">Uruguay</option>
			 		<option value="MLV">Venezuela</option>
			 	</select>
			</form> 
		</header>


		<section class="example">
			<ul id="searchResults"></ul>
		</section>
	
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
		<script type="text/javascript">
		(function (window, undefined) {

			var app = (function() {

				var limit = 15,

					search = {
						offset: 0,
						site: "MLA",
						looking: function (query, offset, site) {
							var offset = (offset == 0) ? offset : (search.offset += limit);
							var site = (site != undefined) ? site : search.site;
							$.getJSON("https://api.mercadolibre.com/sites/" + site +"/search?offset=" + offset + "&limit=" + limit + "&q=" + escape(query) + "&callback=?", search.parseResults);
						},

						parseResults: function (data) {
							var items = [];
							$(data[2].results).each(function (i,e) {

								var title = "<header><a href=\"" + e.permalink + "\">" + e.title + "</a></header>";

								var thumb = "<figure><a href=\"" + e.permalink + "\"><img src=\"" + e.thumbnail + "\" width=\"90\" height=\"90\"></a></figure>";

								var price = "<p class=\"costs\"><span class=\"price\">" + ((e.currency_id == "USD") ? "U$S " : "$ ") + e.price + "</span></p>";

								var row = "<li><article>" + title + thumb + price + "</article></li>";

								items.push(row);

							});

							var html = items.join("");

							$(".loading").remove();

							$("#searchResults").append(html);

							if ($(".more").length != 0) {
								return;
							};

							$(".example").append("<p class=\"actions\"><input type=\"submit\" value=\"More\" class=\"btn secondary skin more\"><p>");
						}
					};

				return search;

			})();

			window.app = app;

		}(window));

		var query, site;

		var init = function (event, offset) {
			event.preventDefault();
			event.stopPropagation();
			$(".actions").remove();
			query = $(".search").val();
			site = $("#site").val();
			app.looking(query, offset, site);
		};

		$("#formBusqueda").bind("submit", function(event){
			$("#searchResults").html("<div class=\"loading\">");
			init(event, 0);
		});

		$(".more").live("click", function(event){
			$("#searchResults").append("<div class=\"loading\">");
			init(event);
		});

		$("#searchResults").bind("click", function(event){
			event = event || window.event;
			var target = event.target || event.srcElement;
			
			if (target.tagName == "A") {
				chrome.tabs.getSelected(null, function(tab) {
					chrome.tabs.update(tab.id, {"url":target.href});
				});
			};
		});
		</script>
	</body>
</html>